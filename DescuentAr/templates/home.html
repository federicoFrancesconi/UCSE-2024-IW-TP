{% extends "base.html" %}

<body>
    {% block content %}
    <form method="GET">
        <label for="categoria">Categor√≠a:</label>
        <select name="categoria_id">
            <option value="">...</option>
            {% for categoria in categorias %}
                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
            {% endfor %}
        </select>
    
        <label for="fecha_hasta">Fecha Hasta:</label>
        <input type="date" name="fecha_hasta">
    
        <label for ="cant_votos">Cantidad votos:</label>
        <input type="form_control" id="formControl" name = "cant_votos">

        <button type="submit">Filtrar</button>
    </form>

    {% for descuento in lista_descuentos %}
        <div class="card">
            <h3 class="card-header">{{ descuento.nombre }}</h3>
            <div class="card-body">
                <p class="card-text">{{ descuento.descripcion }}</p>    
                <a href="{% url 'detalle_descuento' descuento.id %}">Ver detalles</a> 
                
                <div>
                    <button class="btn" id="green"><i class="green fa fa-thumbs-up fa-lg" aria-hidden="true"></i></button>
                    <span id="votos-positivos-{{ descuento.id }}"></span>
                </div>

                <div>
                    <button class="btn" id="red"><i class="fa fa-thumbs-down fa-lg" aria-hidden="true"></i></button>
                    <span id="votos-negativos-{{ descuento.id }}"></span>
                </div>

                <div>
                    <button id="guardar-{{ descuento.id }}" class="btn btn-danger">Guardar</button>
                </div>
            </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script>
            $(document).ready(function()
            {
                var descuentoId = {{ descuento.id }};
                var url_votos = "api/obtener_votos/" + descuentoId + "/";
                var url_guardado = "api/obtener_guardado/" + descuentoId + "/";
    
                $.ajax({
                    url: url_votos,
                    type: "GET",
                    dataType: "json",
                    success: function(data) {
                        $('#votos-positivos-' + descuentoId).text(data.votos_positivos);
                        $('#votos-negativos-' + descuentoId).text(data.votos_negativos);
                    },
                    error: function(error) {
                        console.error("Error al obtener los votos:", error);
                    }
                });

                $.ajax({
                    url: url_guardado,
                    type: "GET",
                    dataType: "json",
                    success: function(data) {
                        if (data.guardado) {
                            $('#guardar-' + descuentoId).text("Quitar de guardados");
                        } else {
                            $('#guardar-' + descuentoId).text("Guardar");
                        }
                    },
                    error: function(error) {
                        console.error("Error al obtener los votos:", error);
                    }
                });
            });

            $('#guardar-' + {{ descuento.id }}).on('click', function() {
                var descuentoId = {{ descuento.id }};

                $.ajax({
                    url: "{% url 'guardar_descuento' %}",
                    type: "POST",
                    data: {
                        descuento_id: descuentoId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        // Update button text based on the response
                        if (response.message === "Descuento guardado correctamente") {
                            $('#guardar-' + descuentoId).text("Quitar de guardados");
                        } else {
                            $('#guardar-' + descuentoId).text("Guardar");
                        }
                    },
                    error: function(error) {
                        console.error("Error al guardar/quitar el descuento:", error);
                    }
                });
            });
        </script>
    
    {% endfor %}
    {% endblock %}
</body>


<style>
    body{
  margin: 40px;
}

button{
  cursor: pointer;
  outline: 0;
  color: #AAA;

}

.btn:focus {
  outline: none;
}

.green{
  color: green;
}

.red{
  color: red;
}
</style>
